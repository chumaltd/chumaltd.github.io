<!DOCTYPE html>
<html data-color-mode="dark" data-light-theme="light" data-dark-theme="dark">
    <head><meta charset="utf-8">
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>IPv6移行 | civilis</title>

<meta name="theme-color" content="rgb(38, 29, 32)">
<link rel='stylesheet' href='//fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=block'>

<link rel='stylesheet' href='/lib/cm.css'>
<link rel="stylesheet" href='/lib/base.css' />

<meta name="twitter:card" content="summary" />
<meta property="og:url" content="https://chumaltd.github.io/ja/ipv6-transition/" />
<meta property="og:title" content="IPv6移行" />
<meta property="og:description" content="インターネット機器はいずれすべてIPv6経由で通信することになる。IPv6に統一できた後、IP層には" />
<meta property="og:image" content='/images/m84jrlxVUc1r9blbt.jpg' />
<link rel="canonical" href=https://chumaltd.github.io/ja/ipv6-transition/ />

<link rel="alternate" hreflang="en" href="https://chumaltd.github.io/en/ipv6-transition/" />
    </head>
    <body class="ja "><header id="global-nav" class="navbar" role="navigation" aria-label="main navigation">
  <section class="container-xl d-flex" style="width: 100%">
  <div class="navbar-brand" style="width: 64px; justify-content: center">
	  <span class="navbar-item"><cm-drawer></cm-drawer></span>
  </div>
  <div class="navbar-brand">
    <a href='/' class="navbar-item" style="display: inline-flex">
	    
	    <img id="footer_logo" src="/common/civilis.svg">
	    
    </a>
    </span>
 </div>
  <div class="navbar-menu">
    <div class="navbar-start">
    </div>
  </div>
  </section>
</header>

<div id ="o" class="o">
<nav class="container-xl" style="overflow: hidden">
  <div class="d-sm-flex">
    <div class="quarter hide-sm"></div>
    <div class="p-3 three-quarter">
        <nav id="breadcrumb" class="breadcrumb is-small px-4 py-3">
<ul>
  <li><a href="/ja/">HOME</a></li>
  <li class="current">&nbsp;IPv6移行</li></ul>
<script type="application/ld+json">
{"@context":"http://schema.org", "@graph":[
	{"@type":"WebSite","id":"https:\/\/chumaltd.github.io\/ja\/","name":"civilis"},
	{"@type":"BreadcrumbList","itemListElement":[
{"@type": "ListItem","position":1,"item":{"@id":"https://chumaltd.github.io/ja/","name": "civilis" }},
{"@type": "ListItem","position":4,"item":{"@id": "https://chumaltd.github.io/ja/ipv6-transition/","name": "IPv6移行" }
}]}
]}
</script>
</nav>

    </div>
  </div>
</nav>
<div class="coverart" style="
        background-image: url(/images/m84jrlxVUc1r9blbt.jpg);
      
      ">
<main class="container-xl">
    <div class="d-sm-flex" style="padding: calc(min(10vw, 1340px)) 0">
    <div class="quarter hide-sm"></div>
    <div id="pagetitle" class="three-quarter px-3">
	<div class="mb-4">
        <h1 class="idx py-5">
          IPv6移行
        </h1><div style="text-align: right; font-weight: 600; font-style: italic">2024/08/27</div></div>
    </div>
  </div>
  <div class="d-sm-flex">
    <nav class="quarter layered">
        <nav class="mb-3 px-5 py-4">
            <a href="/en/ipv6-transition/" class="mx-4">English</a></nav><aside class="toc sticky" style="position: sticky; top: 3em">
        <div class="header"><i class="material-symbols-outlined">toc</i>&nbsp;IPv6移行</div>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#アクセス網のipv6切り替え">アクセス網のIPv6切り替え</a>
      <ul>
        <li><a href="#アドレス設定は複数方式が併存する">アドレス設定は複数方式が併存する</a></li>
        <li><a href="#ルーターを自作するのも一手">ルーターを自作するのも一手</a></li>
      </ul>
    </li>
    <li><a href="#データセンターのipv6切り替え">データセンターのIPv6切り替え</a>
      <ul>
        <li><a href="#localhostの挙動が安定しない">localhostの挙動が安定しない</a></li>
        <li><a href="#仮想ネットワーク構築には知見が必要">仮想ネットワーク構築には知見が必要</a></li>
      </ul>
    </li>
    <li><a href="#ipv4は過去のものになった">IPv4は過去のものになった</a></li>
  </ul>
</nav>
      </aside>
    </nav>
    <div id="content" class="three-quarter">
      <article>
        <p>インターネット機器はいずれすべてIPv6経由で通信することになる。IPv6に統一できた後、IP層には技術的なトラブルや関心はあまり存在しないだろう。<br>
課題は、IPv4とIPv6が併存するデュアルスタックを長期間サポートせざるを得ない点にある。</p>
<p>
<a href="https://en.wikipedia.org/wiki/IPv4_address_exhaustion">IPv4枯渇</a>の公式宣言は2011年からスタートしている。モバイルインターネットは成長を続けており、新たに接続するデバイスはIPv6の比率が高まっていく。</p>
<p>IPv6を導入することの技術障壁は実はあまりない一方で、当面はIPv4をデフォルト設定としている機器が多く、意識して設定しないとIPv6に切り替わらない。<br>
導入よりも移行の方がトラブルが多いため、可能なら最初からIPv6を選択したい。</p>
<h2 id="アクセス網のipv6切り替え">アクセス網のIPv6切り替え</h2>
<p>インターネットに接続する拠点のネットワークは、アクセス網のサービス商品選択で決まる。</p>
<p>日本の場合、家やオフィスと回線接続するNTTが、2011年頃から光ファイバーアクセス商品のネットワーク層をIPv6に切り替えており、該当サービスに加入した拠点がIPv6アクセスになる。<br>
日本のブロードバンド回線は、2002年頃に
<a href="https://en.wikipedia.org/wiki/ADSL">ADSL</a>が急速に普及し、2005年頃から光ファイバーに切り替わってきた。初期から加入してきた回線では、おおむね3世代目の回線変更でIPv4からIPv6へ切り替わったのではないか。</p>
<p>アクセス網の典型的なトラブルは、IPv4 over IPv6トンネルの実装から来る。</p>
<p>IPv4とIPv6は併存していたとしても完全に独立したネットワークであるため、アクセス網がIPv6ネイティブになるとIPv4のサービスには接続できない。<br>
IPv4 over IPv6サービスを追加することでIPv4ネットワークにアクセス可能になるが、いくつかの方式が並立しておりプロバイダ事業者ごとに採用方式が異なる。結局のところIPv4 over IPv6トンネルのうち契約している方式をサポートするルーターが必須と言える。</p>
<p>Wi-Fiアクセスポイントがインターネットルーター機能を備えているケースが多く、どうやら近年は消費者向けのWi-Fiルーターが幅広くIPv4 over IPv6トンネルをサポートしている。<br>
固定回線よりもWi-Fi規格の方が更新ペースが速いため、無線インフラの技術をキャッチアップして機器をリプレースしていると、IPv6切り替えの問題には遭遇しにくいだろう。</p>
<p>一方、企業オフィスのネットワーク構築にはやや難がある。<br>
ルーターがIPv4 over IPv6の一部方式をサポートしていない場合が多々あり、契約している方式と合わなければネット利用に支障が出る。プロバイダを契約する際、サービス説明にはIPv6切り替えの技術的トラブルには言及がないのだが、ルーターの機能で吸収できなければ他に実装手段がない。</p>
<p>IPv4 over IPv6機能は、各種ネットワーク機能の中ではかなり瑣末な機能であるため、本来は重要な選定要件には加えたくないところだ。<br>
IPv4接続プロバイダの時代にはルーターは1台しか接続できなかったのだが、IPv6ではスイッチングハブ経由で複数のルーターを接続できることも多い。そこで今回の移行では、IPv4アクセスしないネットワークを企業向けのルータで併設する構成をとった。</p>
<h3 id="アドレス設定は複数方式が併存する">アドレス設定は複数方式が併存する</h3>
<p>IPv4時代にはIPアドレスの割当てはDHCPを用いてきた。おそらくIPv6では
<a href="https://en.wikipedia.org/wiki/DHCPv6">DHCPv6</a>と<a href="https://en.wikipedia.org/wiki/IPv6_address#Stateless_address_autoconfiguration_(SLAAC)">SLAAC</a>が併存する。<br>
IPv6の規格はSLAACで、潤沢なアドレス空間を生かして各端末がアドレスを自ら決める。DHCPv6はルーターなどの管理機器が決めて配布する。</p>
<p>DHCPv6を採用したいプラットフォームは、WindowsやVoIP機器などだ。要するにLAN管理者が集中管理したい用途ではアドレスも集中的に生成して追跡したい事情がある。一方、端末が移動するモバイル機器は、単一のルーターで集中管理し切れないシーンがあるためSLAACが適している。</p>
<p>よって、IPv6ネットワークの管理方式は規格間の競争ではなく両方生き残るだろう。ネットワーク機器は両方式を同時にサポートできる必要がある。</p>
<h3 id="ルーターを自作するのも一手">ルーターを自作するのも一手</h3>
<p>一般的な方法とは言えないものの、アクセス網に必要な機能をカバーしようと思ったら、ルーターを自作すべきかもしれないと考えている。</p>
<p>後述のとおり、kubernetesのIP網を整備するとルーターを作っているのとほとんど同じ工程をたどる。<br>
また、法人ルーター機器の機能不足が目立っていることや、ARMの進歩によってハードだけはコモディティ化が進んでいることも既製品の相対的な陳腐化の要因と言える。</p>
<p>従来はネットワーク機器を買うことがセキュリティ確保に役立ってきたが、今は既製品のセキュリティ品質が相当疑わしいという問題も大きい。
日本のポピュラーな消費者ブランド機器はほぼソフトウェア脆弱性を抱え、またどの製品もバックドア機能を持つチップが搭載されている可能性は残る。</p>
<p>ネットワークの安全を確認するには、ハードがクリアであることと、ルーティングの定義セットの全容を理解した方が良い。</p>
<h2 id="データセンターのipv6切り替え">データセンターのIPv6切り替え</h2>
<p>企業は、拠点だけでなくデータセンターを借りていることも多い。</p>
<p>上述のとおり、アクセス網をIPv6に切り替えるとIPv4サービスへのアクセスに難が出る場合がある。<br>
IPv6切り替え時にトラブルが起きるとIPv6に技術面の問題があると受けとる人が多そうだが、じっさいにはIPv6ピア間の通信には問題はなく、IPv4サービスとの互換機能にネックがある。</p>
<p>データセンターでシステムを運用している企業の場合、アクセス網がIPv6なのであれば、データセンターのサービスもIPv6に切り替えるべきだ。</p>
<p>IPv4互換性確保には何らかのプロキシ・ソフトウェアを利用するのが手軽だろう。<br>
プロキシは接続先がIPv4/IPv6いずれでも問題なく動作するように作られているため、内部通信をIPv6のみに置き換えることがターゲットになる。</p>
<p>ただし一手で変更することはできず、多くの場合、個別のサービスを１つずつIPv6に移行することになるだろう。サービスの数が増えるほど手間もかさむ。</p>
<p>IPv6への移行着手の前提として、IPv4/IPv6デュアルスタックをサポートする高機能なネットワークを調達できると作業しやすい。ネットワークがシングルスタックの場合には、必然的に別のインフラに移行する方式となり、切り替え範囲が広くなる。</p>
<p>IPv6の挙動は個別のアプリケーションにより異なるため一概には言えない。じっさいにIPv6ネットワークへのルートが存在するだけでIPv4アクセスを排除する挙動のCLIがあり、作業ペースを想定どおりに進められない可能性を感じている。</p>
<p>中にはIPv6では動作しないソフトウェアもあり得る。<br>
IPv4は今後時間をかけてコストが増えていく可能性があり、また
<a href="https://en.wikipedia.org/wiki/Network_address_translation">NAT</a>設定が事実上ロストテクノロジーになることも考えられるため、IPv6互換性のないソフトウェアを特定しておくことは継続性に関わる。</p>
<h3 id="localhostの挙動が安定しない">localhostの挙動が安定しない</h3>
<p>IPv6移行の際、開発用マシン1台の上にネットワーク構成をとるサービスはトラブルが頻発しやすい。</p>
<p>1台構成の多くの場合、各ソフトウェアは<code>localhost</code>というホストで動作する。<code>localhost</code>は典型的にはIPv4では<code>127.0.0.1</code>、IPv6では<code>::1</code>というIPを指している。</p>
<p>ソフトウェアをデフォルト設定で起動した場合、<code>127.0.0.1</code>のみアクセスを受けつける挙動か、<code>::1</code>のみ受けつける挙動かあるいはそれ以外なのか、ユーザーからは判然としない。</p>
<p>そして、クライアントが<code>localhost</code>に接続する設定ではどちらのIPを利用するか紛れがある。</p>
<p>IPv4ホストのみlistenしているサービスに対してIPv6ホストにリクエストする挙動になると同じ機器であっても接続できない。<br>
この場合TCP接続が失敗するため、見なれないエラーを表示して異常終了することも多い。</p>
<p><code>::1</code>を明示的に選択することでルーティングの曖昧さを排除できるが、<code>::1</code>をlistenする設定方法を説明していないソフトウェアが多い点がネックになっている。</p>
<h3 id="仮想ネットワーク構築には知見が必要">仮想ネットワーク構築には知見が必要</h3>
<p>開発ツールにも仮想ネットワークがある場合、既存の構成はIPv4シングルスタックというケースが多い。<br>
仮想ネットワークを用いたクラスタのデファクトはkubernetesであり、kubernetesにはすでにIPv4/IPv6デュアルスタックの実績がある。</p>
<p>おそらく機能面では実用上問題のないレベルと言えるが、導入するにはクラスタの再作成が必要になる。<br>
2024年現在では、どうやらIPv6ネットワークを選択するエンジニアの割合が少ないため、最初から動作するパッケージに仕上がっておらず、適切な構成を試行錯誤する展開になりやすい。</p>
<p>異なる3台のハード上で同一構成のk3sを実行しているが、そのうちの1台だけIPv6の通信エラーが起きている。コンテナ間通信と外部へのリクエストのいずれもエラーになることから、おそらくCPUとホストkernelの特定の組み合わせで生じるバグなのだろう。</p>
<p>仮想ネットワークはOS単体のネットワーク構成よりもはるかに複雑であり、またLinuxのネットワーク実装が従来のiptablesを捨てつつある過渡期ということもあって、初回のセットアップには手間をかける必要があるだろう。</p>
<p>ここ10年のうちに書籍出版がすっかり衰退してしまったため体系的な情報源へのアクセスにも難がある。総合的な知見の乏しさが仇となり、IPv6ネットワーク構築のトラブルシューティングは難易度が高い。</p>
<h2 id="ipv4は過去のものになった">IPv4は過去のものになった</h2>
<p>ソフトウェアエンジニアであってもIPネットワークに関心を持つ割合は相当少ないだろう。多くのソフトウェアがより上位のプロトコルをターゲットにしているからだ。</p>
<p>しかし、意識することなく低レイヤでIPv4を採用しているシステムは多いはずで、10年以上使い続けるつもりならいずれIPv6に移行せざるを得ない。<br>
日常的に操作していないプロトコルの移行は手軽とは言えないので、今から着手するプロジェクトをIPv6上に構築することは将来の手間の節約につながるだろう。</p>
<p>すでに構築してしまったサービスについては、IPv6移行は暗に予期されていたイベントであり、一度は対応することになるはずだ。</p>


	<div class="my-4" style="text-align: right; font-style: italic">
	<span>⁋ 2024/08/27</span><span class="mx-2">↻ 2024/12/03</span></div><div class="related_articles">
              <h4 id="related" class="idx"></h4>
              
              
<a href="/ja/dram-slowdown/" class="compbox bordered py-2">
        <picture>
            <img src="/images/m84jrlxVUc1r9blbt.jpg">
        </picture>
        <div>
            <div class="h4 idx mb-2" href="/ja/dram-slowdown/">DRAMの停滞</div>
            <div class="f6">過去何度かトライしてきたシステム監視サービスにようやく見通しが立った。インハウスで構築できる状況には……</div>
	</div>
</a>
<a href="/ja/datastore-agnosticism/" class="compbox bordered py-2">
        <picture>
            <img src="/images/m84jrlxVUc1r9blbt.jpg">
        </picture>
        <div>
            <div class="h4 idx mb-2" href="/ja/datastore-agnosticism/">不可知なデータストア</div>
            <div class="f6">PostgreSQLは人類でもっとも重要なソフトウェア資産のひとつだ。データセットのごく一部を素朴に……</div>
	</div>
</a>
<a href="/ja/heat-tide/" class="compbox bordered py-2">
        <picture>
            <img src="/images/m84jrlxVUc1r9blbt.jpg">
        </picture>
        <div>
            <div class="h4 idx mb-2" href="/ja/heat-tide/">熱波潮流</div>
            <div class="f6">日本の10月はかつては秋だった。秋を迎える前に「秋めく」時候もあり、涼しい風が吹く日がぽつぽつ混じる……</div>
	</div>
</a>
<a href="/ja/kubernetes-os/" class="compbox bordered py-2">
        <picture>
            <img src="/images/m84jrlxVUc1r9blbt.jpg">
        </picture>
        <div>
            <div class="h4 idx mb-2" href="/ja/kubernetes-os/">KubernetesというOS</div>
            <div class="f6">kubernetesが OSの機能を取り揃えつつある。 OSは多義的な用語で、立場によって欠かせない機能……</div>
	</div>
</a>
<a href="/ja/ipv6-transition/" class="compbox bordered py-2">
        <picture>
            <img src="/images/m84jrlxVUc1r9blbt.jpg">
        </picture>
        <div>
            <div class="h4 idx mb-2" href="/ja/ipv6-transition/">IPv6移行</div>
            <div class="f6">インターネット機器はいずれすべてIPv6経由で通信することになる。IPv6に統一できた後、IP層には……</div>
	</div>
</a>

          </div>

      </article>
    </div>
  </div>
</main>
</div>
</div>
<footer class="footer lazy-block"><div class="container-xl">
      <div>
          <img id="footer_logo" src="/common/civilis.svg" loading="lazy">
          
      </div>
  </div>
</footer><script type="module" src='/lib/cm.js' ></script>
</body>
</html>
